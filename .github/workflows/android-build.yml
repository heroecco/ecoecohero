# =============================================================================
# ECO HERO - ANDROID BUILD WORKFLOW
# Builds signed APK and AAB on every push
# =============================================================================
# 
# REQUIRED GITHUB SECRETS:
#   - ECOHERO_KEYSTORE_BASE64: Base64-encoded keystore file
#   - ECOHERO_KEYSTORE_PASSWORD: Keystore password
#   - ECOHERO_KEY_ALIAS: Key alias name
#   - ECOHERO_KEY_PASSWORD: Key password
#
# =============================================================================

name: Android Build

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    # Allows manual trigger from GitHub Actions tab

# Prevent concurrent builds
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Android APK & AAB
    runs-on: ubuntu-latest
    
    steps:
      # =====================================================================
      # CHECKOUT & SETUP
      # =====================================================================
      
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      # =====================================================================
      # DECODE KEYSTORE FROM SECRETS (SECURE)
      # =====================================================================
      
      - name: Decode keystore from secrets
        env:
          ECOHERO_KEYSTORE_BASE64: ${{ secrets.ECOHERO_KEYSTORE_BASE64 }}
        run: |
          # Create keystore directory
          mkdir -p android/app/keystore
          
          # Decode base64 keystore to file (no echo to prevent log exposure)
          echo "$ECOHERO_KEYSTORE_BASE64" | base64 --decode > android/app/keystore/release.jks
          
          # Verify keystore was created (without exposing content)
          if [ -f "android/app/keystore/release.jks" ]; then
            echo "âœ… Keystore decoded successfully"
            echo "ðŸ“¦ File size: $(stat -c%s android/app/keystore/release.jks) bytes"
          else
            echo "âŒ Failed to decode keystore"
            exit 1
          fi

      # =====================================================================
      # CREATE KEY.PROPERTIES (SECURE)
      # =====================================================================
      
      - name: Create key.properties
        env:
          ECOHERO_KEYSTORE_PASSWORD: ${{ secrets.ECOHERO_KEYSTORE_PASSWORD }}
          ECOHERO_KEY_ALIAS: ${{ secrets.ECOHERO_KEY_ALIAS }}
          ECOHERO_KEY_PASSWORD: ${{ secrets.ECOHERO_KEY_PASSWORD }}
        run: |
          # Verify secrets are not empty
          if [ -z "$ECOHERO_KEYSTORE_PASSWORD" ]; then
            echo "âŒ ECOHERO_KEYSTORE_PASSWORD secret is empty or not set!"
            exit 1
          fi
          if [ -z "$ECOHERO_KEY_ALIAS" ]; then
            echo "âŒ ECOHERO_KEY_ALIAS secret is empty or not set!"
            exit 1
          fi
          if [ -z "$ECOHERO_KEY_PASSWORD" ]; then
            echo "âŒ ECOHERO_KEY_PASSWORD secret is empty or not set!"
            exit 1
          fi
          echo "âœ… All secrets are set"
          
          # Create key.properties without echoing sensitive values
          echo "storePassword=$ECOHERO_KEYSTORE_PASSWORD" > android/key.properties
          echo "keyPassword=$ECOHERO_KEY_PASSWORD" >> android/key.properties
          echo "keyAlias=$ECOHERO_KEY_ALIAS" >> android/key.properties
          echo "storeFile=keystore/release.jks" >> android/key.properties
          
          # Verify file was created with content
          if [ -s "android/key.properties" ]; then
            echo "âœ… key.properties created with $(wc -l < android/key.properties) lines"
          else
            echo "âŒ key.properties is empty!"
            exit 1
          fi

      - name: Verify keystore is valid
        env:
          ECOHERO_KEYSTORE_PASSWORD: ${{ secrets.ECOHERO_KEYSTORE_PASSWORD }}
          ECOHERO_KEY_ALIAS: ${{ secrets.ECOHERO_KEY_ALIAS }}
        run: |
          # Verify keystore using keytool
          if keytool -list -keystore android/app/keystore/release.jks -storepass "$ECOHERO_KEYSTORE_PASSWORD" -alias "$ECOHERO_KEY_ALIAS" > /dev/null 2>&1; then
            echo "âœ… Keystore is valid and contains the key alias"
          else
            echo "âŒ Keystore verification failed! Check password and alias."
            echo "Attempting to list keystore contents..."
            keytool -list -keystore android/app/keystore/release.jks -storepass "$ECOHERO_KEYSTORE_PASSWORD" 2>&1 || true
            exit 1
          fi

      # =====================================================================
      # BUILD FLUTTER APP
      # =====================================================================
      
      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build signed APK (Release)
        run: |
          flutter build apk --release --no-tree-shake-icons
          echo "âœ… APK build completed"

      - name: Build signed AAB (Release)
        run: |
          flutter build appbundle --release --no-tree-shake-icons
          echo "âœ… AAB build completed"

      # =====================================================================
      # VERIFY BUILDS ARE SIGNED (NOT DEBUG)
      # =====================================================================
      
      - name: Verify APK signature
        run: |
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          if [ -f "$APK_PATH" ]; then
            # Check if APK is signed
            if unzip -l "$APK_PATH" | grep -q "META-INF/.*\.SF"; then
              echo "âœ… APK is properly signed"
            else
              echo "âŒ APK is not signed!"
              exit 1
            fi
            echo "ðŸ“¦ APK size: $(stat -c%s "$APK_PATH" | numfmt --to=iec) bytes"
          else
            echo "âŒ APK not found at $APK_PATH"
            exit 1
          fi

      - name: Verify AAB exists
        run: |
          AAB_PATH="build/app/outputs/bundle/release/app-release.aab"
          if [ -f "$AAB_PATH" ]; then
            echo "âœ… AAB build successful"
            echo "ðŸ“¦ AAB size: $(stat -c%s "$AAB_PATH" | numfmt --to=iec) bytes"
          else
            echo "âŒ AAB not found at $AAB_PATH"
            exit 1
          fi

      # =====================================================================
      # CLEANUP SENSITIVE FILES
      # =====================================================================
      
      - name: Cleanup keystore and credentials
        if: always()
        run: |
          # Securely delete keystore
          if [ -f "android/app/keystore/release.jks" ]; then
            shred -u android/app/keystore/release.jks 2>/dev/null || rm -f android/app/keystore/release.jks
            echo "ðŸ—‘ï¸ Keystore deleted"
          fi
          
          # Securely delete key.properties
          if [ -f "android/key.properties" ]; then
            shred -u android/key.properties 2>/dev/null || rm -f android/key.properties
            echo "ðŸ—‘ï¸ key.properties deleted"
          fi
          
          # Remove keystore directory
          rm -rf android/app/keystore
          
          echo "âœ… Cleanup completed"

      # =====================================================================
      # UPLOAD ARTIFACTS
      # =====================================================================
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: eco-hero-apk-${{ github.sha }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
          if-no-files-found: error

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: eco-hero-aab-${{ github.sha }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30
          if-no-files-found: error

      # =====================================================================
      # BUILD SUMMARY
      # =====================================================================
      
      - name: Build summary
        run: |
          echo "## ðŸŽ® Eco Hero - Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| APK (Release) | âœ… Built & Signed |" >> $GITHUB_STEP_SUMMARY
          echo "| AAB (Release) | âœ… Built & Signed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download artifacts from the Actions tab" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”’ **Security**: Keystore and credentials were securely deleted after build" >> $GITHUB_STEP_SUMMARY
