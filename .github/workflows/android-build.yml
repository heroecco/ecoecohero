# =============================================================================
# ECO HERO - ANDROID BUILD WORKFLOW
# Builds signed APK and AAB on every push
# =============================================================================
# 
# REQUIRED GITHUB SECRETS:
#   - ECOHERO_KEYSTORE_BASE64: Base64-encoded keystore file
#   - ECOHERO_KEYSTORE_PASSWORD: Keystore password
#   - ECOHERO_KEY_ALIAS: Key alias name
#   - ECOHERO_KEY_PASSWORD: Key password
#
# SECURITY:
#   - Keystore is decoded from base64 at runtime
#   - Secrets are NEVER printed to logs
#   - All sensitive files are deleted after build
#   - Release builds ONLY - no debug fallback
#
# =============================================================================

name: Android Build

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    # Allows manual trigger from GitHub Actions tab

# Prevent concurrent builds
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.38.5'
  JAVA_VERSION: '17'

jobs:
  build:
    name: Build Android APK & AAB
    runs-on: ubuntu-latest
    
    steps:
      # =====================================================================
      # CHECKOUT & SETUP
      # =====================================================================
      
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Set up Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      # =====================================================================
      # VALIDATE SECRETS (FAIL FAST)
      # =====================================================================
      
      - name: Validate required secrets
        env:
          HAS_KEYSTORE: ${{ secrets.ECOHERO_KEYSTORE_BASE64 != '' }}
          HAS_STORE_PASS: ${{ secrets.ECOHERO_KEYSTORE_PASSWORD != '' }}
          HAS_KEY_ALIAS: ${{ secrets.ECOHERO_KEY_ALIAS != '' }}
          HAS_KEY_PASS: ${{ secrets.ECOHERO_KEY_PASSWORD != '' }}
        run: |
          echo "ðŸ” Validating GitHub Secrets..."
          MISSING=""
          
          if [ "$HAS_KEYSTORE" != "true" ]; then
            MISSING="$MISSING ECOHERO_KEYSTORE_BASE64"
          fi
          if [ "$HAS_STORE_PASS" != "true" ]; then
            MISSING="$MISSING ECOHERO_KEYSTORE_PASSWORD"
          fi
          if [ "$HAS_KEY_ALIAS" != "true" ]; then
            MISSING="$MISSING ECOHERO_KEY_ALIAS"
          fi
          if [ "$HAS_KEY_PASS" != "true" ]; then
            MISSING="$MISSING ECOHERO_KEY_PASSWORD"
          fi
          
          if [ -n "$MISSING" ]; then
            echo "âŒ Missing required secrets:$MISSING"
            echo ""
            echo "Please add the following secrets to your repository:"
            echo "Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            echo ""
            echo "Required secrets:"
            echo "  - ECOHERO_KEYSTORE_BASE64"
            echo "  - ECOHERO_KEYSTORE_PASSWORD"
            echo "  - ECOHERO_KEY_ALIAS"
            echo "  - ECOHERO_KEY_PASSWORD"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

      # =====================================================================
      # DECODE KEYSTORE FROM SECRETS (SECURE)
      # =====================================================================
      
      - name: Decode keystore from secrets
        env:
          ECOHERO_KEYSTORE_BASE64: ${{ secrets.ECOHERO_KEYSTORE_BASE64 }}
        run: |
          # Decode the base64-encoded keystore to a temporary file
          echo "$ECOHERO_KEYSTORE_BASE64" | base64 --decode > $RUNNER_TEMP/release-keystore.jks
          
          # Verify the keystore was created (without exposing contents)
          if [ -f "$RUNNER_TEMP/release-keystore.jks" ]; then
            echo "âœ… Keystore decoded successfully"
          else
            echo "âŒ Failed to decode keystore"
            exit 1
          fi

      # =====================================================================
      # CREATE KEY.PROPERTIES (SECURE)
      # =====================================================================
      
      - name: Create key.properties
        env:
          ECOHERO_KEYSTORE_PASSWORD: ${{ secrets.ECOHERO_KEYSTORE_PASSWORD }}
          ECOHERO_KEY_ALIAS: ${{ secrets.ECOHERO_KEY_ALIAS }}
          ECOHERO_KEY_PASSWORD: ${{ secrets.ECOHERO_KEY_PASSWORD }}
        run: |
          # Create key.properties file for Gradle signing configuration
          # Using ABSOLUTE path for storeFile to avoid path resolution issues
          echo "storePassword=$ECOHERO_KEYSTORE_PASSWORD" > android/key.properties
          echo "keyPassword=$ECOHERO_KEY_PASSWORD" >> android/key.properties
          echo "keyAlias=$ECOHERO_KEY_ALIAS" >> android/key.properties
          echo "storeFile=$RUNNER_TEMP/release-keystore.jks" >> android/key.properties
          echo "âœ… key.properties created successfully"

      # =====================================================================
      # BUILD FLUTTER APP
      # =====================================================================
      
      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build signed APK (Release)
        run: |
          flutter build apk --release
          echo "âœ… Signed APK built successfully"

      - name: Build signed AAB (Release)
        run: |
          flutter build appbundle --release
          echo "âœ… Signed AAB built successfully"

      # =====================================================================
      # CLEANUP SENSITIVE FILES
      # =====================================================================
      
      - name: Clean up sensitive files
        if: always()
        run: |
          # Securely remove keystore and key.properties
          rm -f $RUNNER_TEMP/release-keystore.jks
          rm -f android/key.properties
          echo "âœ… Sensitive files cleaned up"

      # =====================================================================
      # UPLOAD ARTIFACTS
      # =====================================================================
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: eco-hero-apk-${{ github.sha }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
          if-no-files-found: error

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: eco-hero-aab-${{ github.sha }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30
          if-no-files-found: error

      # =====================================================================
      # BUILD SUMMARY
      # =====================================================================
      
      - name: Build summary
        run: |
          echo "## ðŸŽ® Eco Hero - Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| APK (Release) | âœ… Built & Signed |" >> $GITHUB_STEP_SUMMARY
          echo "| AAB (Release) | âœ… Built & Signed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
          echo "Download artifacts from the **Artifacts** section below." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Security" >> $GITHUB_STEP_SUMMARY
          echo "- Keystore decoded from GitHub Secrets only" >> $GITHUB_STEP_SUMMARY
          echo "- No secrets exposed in logs" >> $GITHUB_STEP_SUMMARY
          echo "- All sensitive files securely deleted after build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
