# =============================================================================
# ECO HERO - ANDROID BUILD WORKFLOW
# Builds signed APK and AAB on every push
# =============================================================================
# 
# REQUIRED GITHUB SECRETS:
#   - ECOHERO_KEYSTORE_BASE64: Base64-encoded keystore file
#   - ECOHERO_KEYSTORE_PASSWORD: Keystore password
#   - ECOHERO_KEY_ALIAS: Key alias name
#   - ECOHERO_KEY_PASSWORD: Key password
#
# SECURITY:
#   - Keystore is decoded from base64 at runtime
#   - Secrets are NEVER printed to logs
#   - All sensitive files are deleted after build
#   - Release builds ONLY - no debug fallback
#
# =============================================================================

name: Android Build

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    # Allows manual trigger from GitHub Actions tab

# Prevent concurrent builds
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.27.3'
  JAVA_VERSION: '17'

jobs:
  build:
    name: Build Android APK & AAB
    runs-on: ubuntu-latest
    
    steps:
      # =====================================================================
      # CHECKOUT & SETUP
      # =====================================================================
      
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Set up Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      # =====================================================================
      # VALIDATE SECRETS (FAIL FAST)
      # =====================================================================
      
      - name: Validate required secrets
        env:
          HAS_KEYSTORE: ${{ secrets.ECOHERO_KEYSTORE_BASE64 != '' }}
          HAS_STORE_PASS: ${{ secrets.ECOHERO_KEYSTORE_PASSWORD != '' }}
          HAS_KEY_ALIAS: ${{ secrets.ECOHERO_KEY_ALIAS != '' }}
          HAS_KEY_PASS: ${{ secrets.ECOHERO_KEY_PASSWORD != '' }}
        run: |
          echo "ðŸ” Validating GitHub Secrets..."
          MISSING=""
          
          if [ "$HAS_KEYSTORE" != "true" ]; then
            MISSING="$MISSING ECOHERO_KEYSTORE_BASE64"
          fi
          if [ "$HAS_STORE_PASS" != "true" ]; then
            MISSING="$MISSING ECOHERO_KEYSTORE_PASSWORD"
          fi
          if [ "$HAS_KEY_ALIAS" != "true" ]; then
            MISSING="$MISSING ECOHERO_KEY_ALIAS"
          fi
          if [ "$HAS_KEY_PASS" != "true" ]; then
            MISSING="$MISSING ECOHERO_KEY_PASSWORD"
          fi
          
          if [ -n "$MISSING" ]; then
            echo "âŒ Missing required secrets:$MISSING"
            echo ""
            echo "Please add the following secrets to your repository:"
            echo "Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            echo ""
            echo "Required secrets:"
            echo "  - ECOHERO_KEYSTORE_BASE64"
            echo "  - ECOHERO_KEYSTORE_PASSWORD"
            echo "  - ECOHERO_KEY_ALIAS"
            echo "  - ECOHERO_KEY_PASSWORD"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

      # =====================================================================
      # DECODE KEYSTORE FROM SECRETS (SECURE)
      # =====================================================================
      
      - name: Decode keystore from secrets
        env:
          ECOHERO_KEYSTORE_BASE64: ${{ secrets.ECOHERO_KEYSTORE_BASE64 }}
        run: |
          echo "ðŸ”“ Decoding keystore from base64..."
          
          # Create keystore directory
          mkdir -p android/app/keystore
          
          # Decode base64 keystore to file
          # Remove any whitespace/newlines that might have been introduced
          echo "$ECOHERO_KEYSTORE_BASE64" | tr -d '\n\r ' | base64 --decode > android/app/keystore/release.jks
          
          # Verify keystore was created and has content
          if [ ! -f "android/app/keystore/release.jks" ]; then
            echo "âŒ Failed to create keystore file"
            exit 1
          fi
          
          KEYSTORE_SIZE=$(stat -f%z android/app/keystore/release.jks 2>/dev/null || stat -c%s android/app/keystore/release.jks 2>/dev/null || echo "0")
          
          if [ "$KEYSTORE_SIZE" -lt 100 ]; then
            echo "âŒ Keystore file is too small (${KEYSTORE_SIZE} bytes) - likely corrupted"
            echo "Please regenerate your keystore and update ECOHERO_KEYSTORE_BASE64 secret"
            exit 1
          fi
          
          echo "âœ… Keystore decoded successfully (${KEYSTORE_SIZE} bytes)"

      # =====================================================================
      # CREATE KEY.PROPERTIES (SECURE)
      # =====================================================================
      
      - name: Create key.properties
        env:
          ECOHERO_KEYSTORE_PASSWORD: ${{ secrets.ECOHERO_KEYSTORE_PASSWORD }}
          ECOHERO_KEY_ALIAS: ${{ secrets.ECOHERO_KEY_ALIAS }}
          ECOHERO_KEY_PASSWORD: ${{ secrets.ECOHERO_KEY_PASSWORD }}
        run: |
          echo "ðŸ“ Creating key.properties..."
          
          # Create key.properties in android directory
          # The storeFile path is relative to android/app/ where build.gradle.kts is located
          cat > android/key.properties << EOF
          storePassword=$ECOHERO_KEYSTORE_PASSWORD
          keyPassword=$ECOHERO_KEY_PASSWORD
          keyAlias=$ECOHERO_KEY_ALIAS
          storeFile=keystore/release.jks
          EOF
          
          # Remove leading whitespace from heredoc
          sed -i 's/^[[:space:]]*//' android/key.properties
          
          # Verify file was created
          if [ ! -s "android/key.properties" ]; then
            echo "âŒ Failed to create key.properties"
            exit 1
          fi
          
          echo "âœ… key.properties created successfully"
          echo "ðŸ“„ Properties configured: $(wc -l < android/key.properties) entries"

      # =====================================================================
      # VERIFY KEYSTORE IS VALID
      # =====================================================================
      
      - name: Verify keystore integrity
        env:
          ECOHERO_KEYSTORE_PASSWORD: ${{ secrets.ECOHERO_KEYSTORE_PASSWORD }}
          ECOHERO_KEY_ALIAS: ${{ secrets.ECOHERO_KEY_ALIAS }}
        run: |
          echo "ðŸ” Verifying keystore integrity..."
          
          # Test that keystore can be read with the provided password
          if ! keytool -list -keystore android/app/keystore/release.jks \
                       -storepass "$ECOHERO_KEYSTORE_PASSWORD" \
                       -alias "$ECOHERO_KEY_ALIAS" > /dev/null 2>&1; then
            echo "âŒ Keystore verification failed!"
            echo ""
            echo "Possible causes:"
            echo "  1. ECOHERO_KEYSTORE_PASSWORD is incorrect"
            echo "  2. ECOHERO_KEY_ALIAS does not exist in the keystore"
            echo "  3. ECOHERO_KEYSTORE_BASE64 is corrupted or incomplete"
            echo ""
            echo "Please verify your GitHub Secrets match your keystore"
            
            # Try to list available aliases (without exposing details)
            echo ""
            echo "Attempting to list keystore (checking if password is correct)..."
            if keytool -list -keystore android/app/keystore/release.jks \
                       -storepass "$ECOHERO_KEYSTORE_PASSWORD" > /dev/null 2>&1; then
              echo "Password is correct, but alias '$ECOHERO_KEY_ALIAS' was not found"
              echo "Available aliases in keystore:"
              keytool -list -keystore android/app/keystore/release.jks \
                      -storepass "$ECOHERO_KEYSTORE_PASSWORD" 2>/dev/null | grep "Entry type:" -A0 -B1 || true
            else
              echo "Password verification failed - check ECOHERO_KEYSTORE_PASSWORD"
            fi
            exit 1
          fi
          
          echo "âœ… Keystore is valid and contains the specified key alias"

      # =====================================================================
      # BUILD FLUTTER APP
      # =====================================================================
      
      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build signed APK (Release)
        run: |
          echo "ðŸ”¨ Building signed APK..."
          flutter build apk --release --no-tree-shake-icons
          
          if [ ! -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âŒ APK build failed - file not found"
            exit 1
          fi
          
          echo "âœ… APK build completed"

      - name: Build signed AAB (Release)
        run: |
          echo "ðŸ”¨ Building signed AAB..."
          flutter build appbundle --release --no-tree-shake-icons
          
          if [ ! -f "build/app/outputs/bundle/release/app-release.aab" ]; then
            echo "âŒ AAB build failed - file not found"
            exit 1
          fi
          
          echo "âœ… AAB build completed"

      # =====================================================================
      # VERIFY BUILDS ARE PROPERLY SIGNED (NOT DEBUG)
      # =====================================================================
      
      - name: Verify APK is release-signed
        run: |
          echo "ðŸ” Verifying APK signature..."
          
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          
          # Check if APK exists
          if [ ! -f "$APK_PATH" ]; then
            echo "âŒ APK not found at $APK_PATH"
            exit 1
          fi
          
          # Verify APK is signed (has META-INF signature files)
          if ! unzip -l "$APK_PATH" | grep -q "META-INF/.*\.SF"; then
            echo "âŒ APK is NOT signed - this should not happen!"
            exit 1
          fi
          
          # Verify it's not debug-signed by checking the signature
          # Debug keystore has a known SHA-1 fingerprint pattern
          APK_SIGNER_OUTPUT=$(apksigner verify --print-certs "$APK_PATH" 2>/dev/null || jarsigner -verify -verbose -certs "$APK_PATH" 2>/dev/null | head -20 || true)
          
          # Check for debug signature indicators
          if echo "$APK_SIGNER_OUTPUT" | grep -qi "CN=Android Debug"; then
            echo "âŒ APK is signed with DEBUG certificate!"
            echo "This is a security issue - release builds must use release keystore"
            exit 1
          fi
          
          APK_SIZE=$(stat -f%z "$APK_PATH" 2>/dev/null || stat -c%s "$APK_PATH")
          echo "âœ… APK is properly release-signed"
          echo "ðŸ“¦ APK size: $(numfmt --to=iec $APK_SIZE 2>/dev/null || echo "$APK_SIZE bytes")"

      - name: Verify AAB exists and is valid
        run: |
          echo "ðŸ” Verifying AAB..."
          
          AAB_PATH="build/app/outputs/bundle/release/app-release.aab"
          
          if [ ! -f "$AAB_PATH" ]; then
            echo "âŒ AAB not found at $AAB_PATH"
            exit 1
          fi
          
          AAB_SIZE=$(stat -f%z "$AAB_PATH" 2>/dev/null || stat -c%s "$AAB_PATH")
          echo "âœ… AAB build successful"
          echo "ðŸ“¦ AAB size: $(numfmt --to=iec $AAB_SIZE 2>/dev/null || echo "$AAB_SIZE bytes")"

      # =====================================================================
      # CLEANUP SENSITIVE FILES
      # =====================================================================
      
      - name: Cleanup keystore and credentials
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up sensitive files..."
          
          # Securely delete keystore
          if [ -f "android/app/keystore/release.jks" ]; then
            shred -u android/app/keystore/release.jks 2>/dev/null || rm -f android/app/keystore/release.jks
            echo "  âœ“ Keystore deleted"
          fi
          
          # Securely delete key.properties
          if [ -f "android/key.properties" ]; then
            shred -u android/key.properties 2>/dev/null || rm -f android/key.properties
            echo "  âœ“ key.properties deleted"
          fi
          
          # Remove keystore directory
          rm -rf android/app/keystore 2>/dev/null || true
          
          echo "âœ… Cleanup completed"

      # =====================================================================
      # UPLOAD ARTIFACTS
      # =====================================================================
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: eco-hero-apk-${{ github.sha }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
          if-no-files-found: error

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: eco-hero-aab-${{ github.sha }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30
          if-no-files-found: error

      # =====================================================================
      # BUILD SUMMARY
      # =====================================================================
      
      - name: Build summary
        run: |
          echo "## ðŸŽ® Eco Hero - Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| APK (Release) | âœ… Built & Signed |" >> $GITHUB_STEP_SUMMARY
          echo "| AAB (Release) | âœ… Built & Signed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
          echo "Download artifacts from the **Artifacts** section below." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Security" >> $GITHUB_STEP_SUMMARY
          echo "- Keystore decoded from GitHub Secrets only" >> $GITHUB_STEP_SUMMARY
          echo "- No secrets exposed in logs" >> $GITHUB_STEP_SUMMARY
          echo "- All sensitive files securely deleted after build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
